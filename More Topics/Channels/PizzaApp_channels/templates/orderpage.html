<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Track Your Order</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Boxicons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(45deg, rgba(249, 74, 61, 0.08), rgba(255, 229, 7, 0.08));
            font-family: 'Segoe UI', sans-serif;
        }

        .tracking-card {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            max-width: 900px;
            margin: auto;
        }

        .status-image {
            width: 100%;
            height: 280px;
            border-radius: 12px;
            object-fit: contain;
            background: #f8f8f8;
            padding: 1rem;
        }

        .status-badge {
            background: #f94a3d;
            color: #fff;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .timeline-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .timeline-step i {
            font-size: 22px;
            margin-right: 10px;
            color: #f94a3d;
        }

        .timeline-step.inactive i {
            color: #ccc;
        }
    </style>
</head>

<body>

    <div class="container py-5">
        <div class="tracking-card">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>üçï Track Your Order</h3>
                <span class="status-badge" id="statusText">Preparing</span>
            </div>

            <div class="row g-4">
                {% load static %}
                <!-- Image Container -->
                <div class="col-md-6 text-center">
                    <img id="statusImage" class="status-image" src="{% static 'images/order_received.jpg'%}"
                        alt="Order Status">
                </div>

                <!-- Details -->
                <div class="col-md-6">

                    <p><strong>Order ID:</strong> #PK1023</p>
                    <p><strong>Delivery Address:</strong> Ahmedabad, Gujarat</p>
                    <p><strong>Estimated Time:</strong> <span id="etaText">30 mins</span></p>

                    <hr>

                    <div class="timeline-step" id="step1">
                        <i class="bx bx-receipt"></i> Order Received
                    </div>

                    <div class="timeline-step inactive" id="step2">
                        <i class="bx bx-bowl-hot"></i> Preparing
                    </div>

                    <div class="timeline-step inactive" id="step3">
                        <i class="bx bx-restaurant"></i> Baking
                    </div>

                    <div class="timeline-step inactive" id="step4">
                        <i class="bx bx-cycling"></i> Out for Delivery
                    </div>

                    <div class="timeline-step inactive" id="step5">
                        <i class="bx bx-check-circle"></i> Delivered
                    </div>


                </div>
            </div>
        </div>
    </div>

    <script>
        const STATUS_ETA = {
            order_received: 35,
            preparing: 25,
            baking: 15,
            out_for_delivery: 8,
            delivered: 0
        };
        socket = new WebSocket('ws://127.0.0.1:8000/ws/pizza/{{order_id}}/')

        socket.onopen = function () {
            console.log("Connected")
        }
        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);   // üî¥ REQUIRED
            const status = data['status'];

            console.log("Order status:", status);

            updateOrderStatus(status);
            updateETA(status)

        };

        socket.onclose = function () {
            console.log("WebSocket Disconnected");
        };


        function updateOrderStatus(status) {
            const steps = {
                order_received: 1,
                preparing: 2,
                baking: 3,
                out_for_delivery: 4,
                delivered: 5
            };



            const STATUS_IMAGES = {
                order_received: "{% static 'images/order_received.jpg' %}",
                preparing: "{% static 'images/preparing.jpg' %}",
                baking: "{% static 'images/baking.jpg' %}",
                out_for_delivery: "{% static 'images/delivery-guy-2.svg' %}",
                delivered: "{% static 'images/delivered_.png' %}",
            };

            const activeStep = steps[status];
            if (!activeStep) return;

            for (let i = 1; i <= 5; i++) {
                document
                    .getElementById(`step${i}`)
                    .classList.toggle("inactive", i > activeStep);
            }

            // Optional: update label text
            document.getElementById("statusText").innerText =
                status.replace(/_/g, " ").toUpperCase();

            const img = document.getElementById("statusImage");
            if (STATUS_IMAGES[status]) {
                img.src = STATUS_IMAGES[status];
            }
        }

        function updateETA(status) {
            const etaElement = document.getElementById("etaText");

            if (!STATUS_ETA.hasOwnProperty(status)) {
                etaElement.innerText = "--";
                return;
            }

            const minutes = STATUS_ETA[status];

            etaElement.innerText =
                minutes === 0 ? "Delivered" : `${minutes} mins`;
        }
    </script>

</body>

</html>